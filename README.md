# SIP Server (GB28181 Protocol Implementation)

一个基于C++20的SIP服务器，完整实现了GB28181安防视频监控协议，支持与各种网络摄像头、NVR等设备进行通信和控制。

## 🌟 项目特性

### 核心功能
- **完整的GB28181协议支持**：设备注册、目录查询、实时视频、回放控制
- **多设备管理**：支持摄像头、NVR、音频设备等各类安防设备
- **PTZ云台控制**：全方位云台控制、预置位管理、精确位置控制
- **录像管理**：录像查询、录像播放
- **文件下载**：支持HTTP/FTP方式下载录像文件，带进度监控
- **图像抓拍**：实时抓拍、质量调节、多种格式支持

### 技术特点
- **现代C++20**：使用最新C++标准，包含ranges、coroutines等现代特性
- **高性能架构**：多线程设计，异步事件处理，内存高效管理
- **模块化设计**：各功能模块独立，易于扩展和维护

## 🏗️ 系统架构

```
SIP Server Core
├── SIP协议层 (eXosip2)
├── 设备管理层
├── 媒体控制层
│   ├── PTZ控制
│   ├── 录像回放
│   └── 文件传输
├── 配置管理
└── 事件通知
```

## 📋 功能列表

### 设备管理
- 设备自动注册与认证
- 层次化设备目录管理
- 设备状态监控（在线/离线）
- 父子设备关系维护

### 视频控制
- 实时视频流传输
- PTZ云台控制（8方向+变倍）
- 预置位设置/调用/删除
- 精确位置控制

### 录像功能
- 按时间范围查询录像
- 多时间段录像回放

### 文件操作
- 录像文件下载（HTTP/FTP）
- 下载进度监控和取消
- 自动文件存储管理
- 断点续传支持

### 图像处理
- 实时图像抓拍
- 图像质量调节
- 多种格式支持（JPEG/PNG）
- 批量抓拍管理

## 🛠️ 构建依赖

### 必需库
- **eXosip2/oSiP** - SIP协议栈
- **tinyxml2** - XML解析
- **libcurl** - HTTP/FTP传输
- **OpenSSL** - 安全通信

### 构建工具
- CMake 3.10.2+
- C++20兼容编译器（GCC/Clang/MSVC）

## 📥 安装与使用

### 快速开始
```bash
# 克隆项目
git https://github.com/Innnoa/SIP-Server-GB28181-Protocol-Implementation.git
cd sipserver

# 构建项目
mkdir build && cd build
cmake ..
make -j4

# 运行服务器
./sipserver
```

### 配置示例
```cpp
server_info info(
    "SIP-Server/1.0",           // User Agent
    "1234567890123456",         // Nonce
    "192.168.1.100",            // 服务器IP
    5060,                       // SIP端口
    10000,                      // RTP端口
    "34020000002000000001",     // 服务器ID
    "3402000000",               // SIP域
    "your_password",            // 密码
    1800,                       // 会话超时
    3600                        // 注册有效期
);
```

## 🎮 交互式控制

项目提供完整的命令行界面，支持以下操作：

1. **设备管理** - 查看注册设备、刷新目录
2. **PTZ控制** - 云台控制、预置位操作
3. **录像操作** - 查询、回放、下载
4. **系统监控** - 状态查看、会话管理

## 📁 项目结构

```
sipserver/
├── CMakeLists.txt          # 构建配置
├── main.cpp               # 主程序入口
├── SipServer.h/cpp        # 核心服务器实现
├── Utils/                 # 工具类
│   ├── Log.cpp/h          # 日志系统
│   ├── MD5.c/h            # MD5计算
│   └── HTTPDigest.c/h     # HTTP摘要认证
└── docs/                  # 文档
    └── README.md
```

## 🔧 配置选项

### 网络配置
- SIP监听端口配置
- RTP传输端口范围
- 网络超时设置
- 心跳保持间隔

### 存储配置
- 下载文件存储路径
- 抓拍图像存储目录
- 日志文件配置
- 缓存大小限制

## 🌐 协议支持

### GB28181-2016 核心功能
- 设备注册与保活
- 设备目录查询
- 实时视频点播
- 历史视频回放
- 云台控制
- 报警通知

### 扩展功能
- 设备配置管理
- 状态信息查询
- 网络参数配置
- 设备升级管理

## 📄 许可证

本项目采用MIT许可证 - 详见[LICENSE](LICENSE)文件。
